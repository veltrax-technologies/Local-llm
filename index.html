<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Veltrax — Local LLM Deployment Simulator</title>
<style>
  :root{
    --bg:#0d1117; --surface:#0f1421; --panel:#121a2a; --text:#e6ecf3; --muted:#9aa7b6; --border:#223047; --accent:#6f42c1; --accent2:#7aa3ff; --good:#2ecc71; --warn:#ffb454; --bad:#ff6b6b;
  }
  .light:root{ --bg:#f7f9fc; --surface:#ffffff; --panel:#ffffff; --text:#1b2430; --muted:#5a6b83; --border:#d9e2ef; --accent:#6f42c1; --accent2:#4a7dff; --good:#1fa971; --warn:#e39b2e; --bad:#e05656; }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--text);font:15px/1.6 system-ui,-apple-system,Segoe UI,Inter,Roboto,Arial,sans-serif}
  a{color:var(--accent2);text-decoration:none}
  header{position:sticky;top:0;z-index:20;background:linear-gradient(to bottom,rgba(2,6,23,.7),rgba(2,6,23,.2)),var(--surface);border-bottom:1px solid var(--border);display:flex;align-items:center;gap:12px;padding:12px 16px}
  .logo{width:28px;height:28px;border-radius:8px;background:linear-gradient(135deg,var(--accent),var(--accent2))}
  .title{font-weight:700}
  .spacer{flex:1}
  .toggle{border:1px solid var(--border);background:var(--panel);padding:8px 12px;border-radius:10px;color:var(--text);cursor:pointer}

  .wrap{max-width:1200px;margin:0 auto;padding:16px}
  .grid{display:grid;grid-template-columns:1.15fr .8fr 1.25fr;gap:14px}
  .card{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:14px}
  h2{margin:0 0 8px 0;font-size:18px}
  label{font-weight:600;display:block;margin:10px 0 4px}
  select,input[type=number]{width:100%;padding:10px;border-radius:10px;border:1px solid var(--border);background:var(--surface);color:var(--text)}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .switch{display:inline-flex;align-items:center;gap:8px;margin:6px 8px 0 0}
  .switch input{width:18px;height:18px}
  .preset{display:flex;flex-direction:column;gap:10px}
  .preset button,.btn{border:1px solid var(--border);background:linear-gradient(180deg,rgba(255,255,255,.04),rgba(255,255,255,0));padding:10px 12px;border-radius:10px;color:var(--text);font-weight:700;cursor:pointer;width:100%;text-align:left}
  .btn.inline{width:auto}

  /* Outputs */
  .tiles{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
  .tile{border:1px solid var(--border);border-radius:12px;padding:12px;background:var(--surface)}
  .big{font-size:22px;font-weight:800}
  .muted{color:var(--muted)}
  .badge{display:inline-block;padding:3px 8px;border-radius:999px;font-size:12px;font-weight:700}
  .safe{background:rgba(46,204,113,.15);color:var(--good);border:1px solid rgba(46,204,113,.35)}
  .border{background:rgba(255,180,84,.15);color:var(--warn);border:1px solid rgba(255,180,84,.35)}
  .over{background:rgba(255,107,107,.15);color:var(--bad);border:1px solid rgba(255,107,107,.35)}
  .bar{height:10px;border-radius:6px;background:#1b2437;border:1px solid var(--border);overflow:hidden}
  .bar>span{display:block;height:100%;background:linear-gradient(90deg,var(--accent2),var(--accent));width:0%}

  table{width:100%;border-collapse:collapse;margin-top:12px}
  th,td{border:1px solid var(--border);padding:8px;text-align:left}
  th{background:rgba(255,255,255,.03)}
  .mono{font-family:ui-monospace,SFMono-Regular,Consolas,monospace}

  /* Footer + CTA */
  .teaser{margin:16px 0;border:1px dashed var(--border);border-radius:12px;padding:12px;display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap;background:rgba(255,255,255,.02)}
  .founders{margin:14px 0;border:2px solid var(--accent);background:linear-gradient(180deg,rgba(111,66,193,.10),rgba(111,66,193,.02));border-radius:14px;padding:14px}
  footer{color:var(--muted);border-top:1px solid var(--border);padding:14px;margin-top:16px}

  @media (max-width: 980px){ .grid{grid-template-columns:1fr} .tiles{grid-template-columns:1fr} }
</style>
</head>
<body>
<header>
  <div class="logo" aria-hidden="true"></div>
  <div class="title">Veltrax — Local LLM Deployment Simulator</div>
  <div class="spacer"></div>
  <button id="theme" class="toggle" aria-label="Toggle theme">Toggle theme</button>
</header>

<main class="wrap">
  <section class="grid" aria-label="3-column layout">
    <!-- Inputs -->
    <div class="card" aria-label="Inputs">
      <h2>Inputs</h2>
      <label for="hardware">Hardware</label>
      <select id="hardware" aria-label="Hardware">
        <option>RTX 5090 (est. 32GB)</option>
        <option>RTX 6000 Ada (48GB)</option>
        <option>H100 80GB</option>
        <option>H200 141GB</option>
      </select>

      <div class="row">
        <div>
          <label for="model">Model size</label>
          <select id="model" aria-label="Model size">
            <option>7B</option>
            <option>13B</option>
            <option>20B</option>
          </select>
        </div>
        <div>
          <label for="quant">Quantization</label>
          <select id="quant" aria-label="Quantization">
            <option>Q4</option>
            <option>Q5</option>
            <option>FP16</option>
          </select>
        </div>
      </div>

      <div class="row">
        <div>
          <label for="context">Max context tokens</label>
          <input id="context" type="number" min="512" step="256" value="4096" aria-label="Max context tokens"/>
        </div>
        <div>
          <label for="batch">Batch size</label>
          <input id="batch" type="number" min="1" step="1" value="8" aria-label="Batch size"/>
        </div>
      </div>

      <label for="concurrency">Concurrent sessions (requested)</label>
      <input id="concurrency" type="number" min="1" step="1" value="16" aria-label="Concurrent sessions"/>

      <div aria-label="Guardrails" style="margin-top:8px">
        <strong>Guardrails</strong>
        <div>
          <label class="switch"><input type="checkbox" id="rag" checked aria-label="Enable RAG"/> RAG</label>
          <label class="switch"><input type="checkbox" id="pii" checked aria-label="Enable PII redaction"/> PII redaction</label>
          <label class="switch"><input type="checkbox" id="block" checked aria-label="Enable prompt blocklist"/> Prompt blocklist</label>
        </div>
      </div>

      <div style="margin-top:12px;display:flex;gap:10px;flex-wrap:wrap">
        <button class="btn inline" id="export" aria-label="Export config as JSON">Export llm_config.json (↵)</button>
        <button class="btn inline" id="reset">Reset</button>
      </div>
    </div>

    <!-- Presets -->
    <div class="card" aria-label="Presets">
      <h2>Presets</h2>
      <div class="preset">
        <button data-preset="finex">Finex — Banking</button>
        <button data-preset="echelon">ÉCHELON — Retail</button>
        <button data-preset="verdict">Verdict — Legal</button>
      </div>
      <p class="muted" style="margin-top:10px">Presets optimize for <strong>concurrency</strong>. The scheduler will queue overflow to protect hardware.</p>
    </div>

    <!-- Outputs -->
    <div class="card" aria-label="Outputs">
      <h2>Live Estimates</h2>
      <div style="display:flex;align-items:center;gap:8px;margin:6px 0 12px">
        <span class="muted">Fit status:</span>
        <span id="fitBadge" class="badge">—</span>
      </div>

      <div class="tile" aria-label="VRAM usage">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <strong>VRAM</strong>
          <span class="muted" id="vramLabel">—</span>
        </div>
        <div class="bar" aria-hidden="true"><span id="vramBar"></span></div>
        <div class="muted" style="margin-top:6px">Headroom: <span id="headroom">—</span></div>
      </div>

      <div class="tiles" style="margin-top:10px">
        <div class="tile" aria-label="Tokens per second">
          <div class="muted">Tokens/sec (effective)</div>
          <div class="big" id="tps">—</div>
        </div>
        <div class="tile" aria-label="Max safe concurrency">
          <div class="muted">Max safe concurrency</div>
          <div class="big" id="safeConc">—</div>
        </div>
        <div class="tile" aria-label="p50 latency">
          <div class="muted">p50 latency</div>
          <div class="big" id="p50">—</div>
        </div>
        <div class="tile" aria-label="p95 latency">
          <div class="muted">p95 latency</div>
          <div class="big" id="p95">—</div>
        </div>
      </div>

      <div class="tile" style="margin-top:10px" aria-label="Queue wait">
        <div class="muted">Estimated queue wait (p50)</div>
        <div class="big" id="qwait">—</div>
      </div>

      <h2 style="margin-top:14px">Scenario Comparison (hardware × model)</h2>
      <table aria-label="Scenario comparison table">
        <thead>
          <tr><th>Hardware</th><th>7B</th><th>13B</th><th>20B</th></tr>
        </thead>
        <tbody id="compareBody"></tbody>
      </table>
    </div>
  </section>

  <!-- CTA / Next -->
  <div class="founders" role="note" aria-label="Founders deal">
    <strong>Founders deal:</strong> 30% upfront with milestone deliveries. First 5 get <strong>15% off</strong> + <strong>1 year support</strong>.
  </div>
  <div class="teaser" role="region" aria-label="Next page">
    <div><strong>Next:</strong> Security & Compliance Map — see threats mapped to controls and evidence.</div>
    <a class="btn" href="PASTE_NEXT_URL_HERE">Open Security Map</a>
  </div>

  <footer>
    <small>Estimates are conservative.</small>
  </footer>
</main>

<script>
// ======= Heuristics (simple & fast) ======= //
const HW = {
  'RTX 5090 (est. 32GB)': { vram: 32, idx: 18 },
  'RTX 6000 Ada (48GB)': { vram: 48, idx: 20 },
  'H100 80GB': { vram: 80, idx: 30 },
  'H200 141GB': { vram: 141, idx: 36 }
};
const PREC_BYTES = { 'Q4': 0.5, 'Q5': 0.7, 'FP16': 2.0 }; // bytes/param (approx)
const QUANT_SPEED = { 'Q4': 1.30, 'Q5': 1.15, 'FP16': 1.0 };
const MODELS_B = { '7B': 7, '13B': 13, '20B': 20 };

const el = id => document.getElementById(id);
const $hardware=el('hardware'), $model=el('model'), $quant=el('quant');
const $context=el('context'), $batch=el('batch'), $conc=el('concurrency');
const $rag=el('rag'), $pii=el('pii'), $block=el('block');
const fitBadge=document.getElementById('fitBadge');
const vramLabel=document.getElementById('vramLabel');
const vramBar=document.getElementById('vramBar');
const headroom=document.getElementById('headroom');
const tpsEl=document.getElementById('tps'), p50El=document.getElementById('p50'), p95El=document.getElementById('p95'), safeConcEl=document.getElementById('safeConc');
const qwaitEl=document.getElementById('qwait');

function clamp(n,min,max){ return Math.min(max,Math.max(min,n)); }

function estimate(hardware, B, quant, ctx, batch, conc, rag, pii, block){
  const hw = HW[hardware];
  const bytes = PREC_BYTES[quant];
  // Weights memory ~ params * bytes (GB)
  const weightsGB = (B * bytes);
  // KV cache (approx): scales with context, conc, bytes, size
  const kvGB = ctx * conc * bytes * B * 0.00002; // tuned for sensible numbers
  const runtimeGB = 2 + (conc*0.1);
  const guardGB = (rag?1.0:0) + (pii?0.5:0) + (block?0.2:0);
  const totalGB = weightsGB + kvGB + runtimeGB + guardGB;

  const cap = hw.vram; // GB
  const usedPct = cap>0? clamp((totalGB/cap)*100,0,100):100;
  const head = Math.max(0, cap - totalGB);

  // Throughput (tokens/sec)
  const base = hw.idx * 15; // baseline index
  const sizeFactor = 7 / B; // bigger models slower
  const quantFactor = QUANT_SPEED[quant];
  const batchFactor = 1 + 0.22 * (batch-1);
  let tps = base * sizeFactor * quantFactor * batchFactor; // aggregate throughput
  tps = Math.max(1, tps);

  // Safe concurrency from memory budget
  const perSessionKV = ctx * bytes * B * 0.00002 + 0.05; // KV + buffer
  let memForSessions = Math.max(0, cap - (weightsGB + guardGB + 1.5));
  let safeConc = Math.max(1, Math.floor(memForSessions / perSessionKV));

  // Effective TPS under contention
  const pressure = conc/safeConc; // >1 means queueing
  const effTps = tps / Math.max(1, pressure);
  const p50 = (1000 / effTps) + 30; // ms; simple
  const p95 = p50 * 1.8;

  // Queue wait: use p50 service time and oversub ratio
  const tokensPerReq = Math.max(256, Math.round(ctx*0.25));
  const serviceMs = (tokensPerReq / effTps) * 1000; // per request
  const over = Math.max(0, conc - safeConc);
  const qwaitMs = over>0 ? (over/safeConc) * serviceMs : 0;

  let fitClass='safe', fitText='Safe';
  if(totalGB>cap){ fitClass='over'; fitText='Overcommit'; }
  else if(totalGB>cap*0.9){ fitClass='border'; fitText='Borderline'; }

  return {totalGB, cap, usedPct, head, tps:effTps, p50, p95, safeConc, qwaitMs, fitClass, fitText};
}

function render(){
  const hw=$hardware.value, B=MODELS_B[$model.value], q=$quant.value, ctx=+($context.value||4096), batch=+( $batch.value||8 ), conc=+($conc.value||1);
  const rag=$rag.checked, pii=$pii.checked, block=$block.checked;
  const r=estimate(hw,B,q,ctx,batch,conc,rag,pii,block);

  // VRAM
  vramBar.style.width = r.usedPct + '%';
  vramLabel.textContent = `${r.totalGB.toFixed(1)} GB / ${r.cap} GB`;
  headroom.textContent = r.head.toFixed(1) + ' GB';

  // Badge
  fitBadge.className = `badge ${r.fitClass}`; fitBadge.textContent = r.fitText;

  // Numbers
  document.getElementById('tps').textContent = r.tps.toFixed(0);
  document.getElementById('p50').textContent = `${r.p50.toFixed(0)} ms`;
  document.getElementById('p95').textContent = `${r.p95.toFixed(0)} ms`;
  document.getElementById('safeConc').textContent = r.safeConc.toString();
  qwaitEl.textContent = (r.qwaitMs>0? `${r.qwaitMs.toFixed(0)} ms` : '0 ms');

  // Comparison table (hardware × model with current settings for quant/context/batch/conc)
  const tbody=document.getElementById('compareBody'); tbody.innerHTML='';
  const hwNames=Object.keys(HW); const modelNames=Object.keys(MODELS_B);
  for(const h of hwNames){
    const tr=document.createElement('tr');
    const th=document.createElement('td'); th.textContent=h; th.className='mono'; tr.appendChild(th);
    for(const m of modelNames){
      const rr=estimate(h, MODELS_B[m], q, ctx, batch, conc, rag, pii, block);
      const td=document.createElement('td');
      td.innerHTML = `<span class="mono">SC ${rr.safeConc}</span> · <span class="muted">Q ${rr.qwaitMs>0? rr.qwaitMs.toFixed(0)+'ms':'0ms'}</span>`;
      tr.appendChild(td);
    }
    tbody.appendChild(tr);
  }

  // cache for export
  window.__llm_state = { hardware:hw, model:$model.value, quant:q, context:ctx, batch, concurrency:conc, guardrails:{RAG:rag,PII_Redaction:pii,PromptBlocklist:block}, estimates:{ vram_total_gb:+r.totalGB.toFixed(2), vram_capacity_gb:r.cap, tokens_per_sec:+r.tps.toFixed(0), p50_ms:+r.p50.toFixed(0), p95_ms:+r.p95.toFixed(0), safe_concurrency:r.safeConc, queue_wait_p50_ms:+r.qwaitMs.toFixed(0), fit:r.fitText }, comparison_table_generated:true };
}

// Inputs → render (fast, <50ms)
['change','input','keyup'].forEach(ev=>{
  document.addEventListener(ev, e=>{
    if(e.target && (e.target.id||'').match(/hardware|model|quant|context|batch|concurrency|rag|pii|block/)) render();
  })
});

// Presets emphasize concurrency
const applyPreset = (p)=>{
  const pmap = {
    finex:   { hardware:'RTX 6000 Ada (48GB)', model:'13B', quant:'Q5', context:4096, batch:8,  concurrency:40, rag:true, pii:true, block:true },
    echelon: { hardware:'RTX 5090 (est. 32GB)', model:'7B',  quant:'Q4', context:3072, batch:16, concurrency:60, rag:true, pii:true, block:true },
    verdict: { hardware:'H100 80GB',           model:'20B', quant:'FP16',context:8192, batch:4,  concurrency:20, rag:true, pii:true, block:true }
  }[p];
  if(!pmap) return;
  $hardware.value=pmap.hardware; $model.value=pmap.model; $quant.value=pmap.quant;
  $context.value=pmap.context; $batch.value=pmap.batch; $conc.value=pmap.concurrency;
  $rag.checked=pmap.rag; $pii.checked=pmap.pii; $block.checked=pmap.block; render();
};

document.querySelectorAll('[data-preset]').forEach(b=> b.addEventListener('click', ()=> applyPreset(b.dataset.preset)) );

document.getElementById('reset').addEventListener('click',()=>{ $hardware.selectedIndex=0; $model.value='13B'; $quant.value='Q5'; $context.value=4096; $batch.value=8; $conc.value=32; $rag.checked=$pii.checked=$block.checked=true; render(); });

// Export config
function exportConfig(){
  const data = window.__llm_state || {}; const blob = new Blob([JSON.stringify(data,null,2)], {type:'application/json'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='llm_config.json'; document.body.appendChild(a); a.click(); setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); }, 0);
}
document.getElementById('export').addEventListener('click', exportConfig);
document.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ exportConfig(); }});

// Theme
const themeBtn=document.getElementById('theme');
themeBtn.addEventListener('click',()=>{ document.documentElement.classList.toggle('light'); });

// first render
applyPreset('echelon');
</script>
</body>
</html>
